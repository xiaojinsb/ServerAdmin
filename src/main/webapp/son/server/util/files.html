<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>文件上传</title>
    <link rel="stylesheet" href="../../../statics/plugins/layui/css/layui.css" media="all">
    <style>
        .layui-form-label{width: 100px}
        .layui-input-block{margin-left: 130px}
    </style>
</head>
<body>

<div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief" style="margin-left: 20px">
    <ul class="layui-tab-title">
        <li class="layui-this" >管理文件</li>
        <li>上传文件</li>
    </ul>
    <div class="layui-tab-content" style="height: 100px;">
        <div class="layui-tab-item layui-show">
            <table id="tableList" lay-filter="tableList"></table>
        </div>
        <div class="layui-tab-item">

            <div class="layui-upload" id="container">
                <button type="button" class="layui-btn layui-btn-normal" id="pickfiles">选择多文件</button>
                <button type="button" class="layui-btn layui-btn-normal" id="empty">清空</button>
                <div class="layui-upload-list">
                    <table class="layui-table">
                        <thead>
                        <tr>
                            <th>文件名</th>
                            <th>大小</th>
                            <th>状态</th>
                            <th>进度</th>
                            <th>操作</th>
                        </tr>
                        </thead>

                        <tbody id="uploadingFiles"></tbody>

                    </table>
                </div>
                <button type="button" class="layui-btn" id="uploadfiles" style="display: block">开始上传</button>
            </div>

        </div>
    </div>
</div>

<script src="../../../statics/plugins/layui/layui.js"></script>
<script src="../../../statics/src/js/plupload.js"></script>
<script>
    layui.use(['jquery','layer','element','table'], function () {
        $ = layui.jquery;
        var layer = layui.layer,
        element = layui.element,
        table = layui.table;

        //获取url传过来的值
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for(var i = 0; i < strs.length; i ++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        var fileClassify =  theRequest['fileClassify'];
        var fileId = theRequest['fileId'];

        //渲染表格
        var tablelist = table.render({
            id: 'table'
            , elem: '#tableList' //选择表单
            , url: '../../../server/list' //json返回地址
            , page: true //分页 开启
            // , height: 'full-125' // 高度 距离底部
            , cols: [ //表头 //sort 是否开启排序 //fixed 开启操作是否悬浮
                [
                    {type: 'checkbox', fixed: "left"}
                    , {field: 'serverId', title: 'id', align: 'center', sort: true, width: 70}
                    , {field: 'serverName', title: '文件名',  align: 'center', width: 130}
                    , {field: 'serNet', title: '文件地址', align: 'center', width: '100'}
                    , {field: 'depSituation', title: '创建者', align: 'center', width: '100'}
                    , {field: 'type', title: '创建时间', align: 'center', width: '100'}
                    , {field: 'userName', title: '更新时间', align: 'center', width: '100'}
                    , {title: '操作', toolbar: '#operationTpl', fixed: "right", width: 250}
                ]
            ]
        });

        var filesId = [];
        //上传
        var uploader = new plupload.Uploader({
            runtimes : 'html4',
            browse_button : 'pickfiles',
            container: document.getElementById('container'),
            url : '../../../parses/uploadFile?fileClassify='+fileClassify+'&fileId='+fileId,
            flash_swf_url : '../../../statics/src/images/Moxie.swf',
            max_file_size : '100mb',
            // chunk_size: '10mb', //分片上传

            filters : {
                prevent_duplicates : true,
                mime_types: [
                    {title : "files", extensions : "zip,pdf,doc,exe,msi,xlsx,txt"}
                ],
            },

            init: {
                PostInit: function() {
                    $("#uploadingFiles").html("");

                    document.getElementById('uploadfiles').onclick = function() {
                        uploader.start();
                        console.log("一共有"+uploader.total.queued);
                        return false;
                    };
                },

                FilesAdded: function(up, files) {
                    console.log(uploader.total.size)
                    plupload.each(files, function(file) {
                        $("#uploadingFiles").append('<tr class="fileList" id='+file.id+'>\n' +
                            '    <td>'+ file.name+'</td>\n' +
                            '    <td>'+plupload.formatSize(file.size)+'</td>\n' +
                            '    <td>等待上传</td>\n' +
                            '    <td>0%</td>\n' +
                            '    <td><button class="layui-btn layui-btn-mini layui-btn-danger fileDelete" data-val='+file.id+'>删除</button></td>\n' +
                            '</tr>\n');
                    });
                },

                UploadProgress: function(up, file) {
                    $("#" + file.id + " td:eq(3)").html(file.percent+"%");

                },

                FileUploaded: function(up, file) {
                    $("#" + file.id + " td:eq(2)").html("上传成功");
                    console.log("总进度"+uploader.total.percent);
                    console.log("已完成"+uploader.total.uploaded);
                },

                Error: function(up, err) {
                    $("#" + err.file.id + " td:eq(2)").html(err.message);
                    console.log(err)
                }
            }

        });

        uploader.init();

        $("#empty").click(function () {
            var fileDelete = $('.fileDelete');
            var toremove = '';
            $("#uploadingFiles").html("");
            for (var i = 0; i < fileDelete.length; i++) {
                var id=fileDelete.eq(i).attr("data-val");
                for(var j in uploader.files){
                    if(uploader.files[j].id === id){
                        toremove = j;
                    }
                }
                uploader.files.splice(toremove, 1);
            }
        })

        //删除上传队列
        $(document).on('click','#uploadingFiles tr .fileDelete',function(){
            $(this).parent().parent().remove();
            var toremove = '';
            var id=$(this).attr("data-val");
            for(var i in uploader.files){
                if(uploader.files[i].id === id){
                    toremove = i;
                }
            }
            uploader.files.splice(toremove, 1);
        });
    });

</script>
</body>
</html>